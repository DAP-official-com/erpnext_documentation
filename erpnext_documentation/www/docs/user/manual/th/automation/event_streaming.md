 <!-- add-breadcrumbs -->
# สตรีมมิ่ง

> Introduced in Version 13

การสตรีมเหตุการณ์ช่วยให้สามารถสื่อสารระหว่างไซต์ระหว่างสองไซต์ขึ้นไป คุณสามารถ **สมัครใช้งาน** ประเภทเอกสารและ **สตรีม** เอกสารระหว่างไซต์ต่างๆ ได้

ตัวอย่างเช่น: พิจารณาว่าคุณมีบริษัทมากกว่าหนึ่งแห่งที่โฮสต์อยู่ในไซต์ต่างๆ กัน หนึ่งในนั้นคือไซต์หลักที่คุณต้องการโพสต์บัญชีแยกประเภท และบนไซต์อื่นๆ จะมีการสร้างใบแจ้งหนี้การขาย คุณสามารถใช้ สตรีมมิ่ง ได้ในกรณีนี้ สำหรับสิ่งนี้ ไซต์บริษัทลูกของคุณสามารถสมัครใช้งานไซต์บริษัทหลักสำหรับประเภทเอกสารของสินค้า ลูกค้า และผู้จัดจำหน่ายได้ บริษัทหลักสามารถสมัครบริษัทย่อยสำหรับใบแจ้งหนี้การขายได้

ในการเข้าถึงการสตรีมกิจกรรม ไปที่:
> หน้าหลัก > ระบบอัตโนมัติ > การสตรีมเหตุการณ์

## 1. ข้อกำหนดเบื้องต้น

ก่อนสร้าง Event Producer ผู้ใช้ทั่วไปจะต้องถูกสร้างขึ้นบนทั้งสองไซต์ซึ่งจะใช้ในการเข้าถึงไซต์และจะทำหน้าที่เป็นผู้สมัครสมาชิกกิจกรรม ตรวจสอบว่าผู้ใช้เป็นผู้ดูแลระเบบ (System Manager) และมีสิทธิ์ที่จำเป็นสำหรับการสร้าง อัปเดต และลบเอกสาร DocTypes ที่สมัครรับข้อมูล

## 2. วิธีตั้งค่าการสตรีมมิ่ง

ลองใช้ไซต์สองไซต์เพื่ออธิบายกระบวนการ http://test site:8000 (ไซต์ผู้บริโภค) และ http://test site_producer:8000 (ไซต์ผู้ผลิต)

### 2.1 รับรหัสสมาชิกกิจกรรมจากไซต์ผู้ผลิต

1. บน http://test ไซต์โปรดิวเซอร์:8000 (ไซต์ผู้ผลิต) ไปที่รายการผู้ใช้
2. เปิดเอกสารผู้ใช้ที่คุณจะใช้เป็น Event Subscriber เลื่อนลงไปที่ส่วน "การเข้าถึง API" ในส่วนที่สร้างคีย์สำหรับผู้ใช้โดยการคลิกที่สร้างคีย์ปุ่ม คุณจะได้รับข้อความแจ้งพร้อมข้อมูลลับผู้ใช้ คัดลอกข้อมูลลับผู้ใช้ และบันทึกกับคุณ นอกจากนี้ยังจะสร้างคีย์ API

### 2.2 สร้างคีย์สำหรับสมาชิกเหตุการณ์บนเว็บไซต์ผู้บริโภค

1. บน http://test_site:8000 (ไซต์สำหรับผู้บริโภค) ให้ไปที่รายการผู้ใช้ และทำตามขั้นตอนเดียวกันกับที่ระบุไว้ในขั้นตอนก่อนหน้า

### สร้างผู้ผลิตเหตุการณ์บนเว็บไซต์ผู้บริโภค

1. ไซต์ที่คุณต้องการสมัครรับข้อมูล เรียกว่า Event Producer สร้างเอกสาร Event Producer สำหรับไซต์ที่คุณต้องการรับการอัปเดต
2. เมื่อวันที่ http: // test_site: 8000 (เว็บไซต์ผู้บริโภค) ให้ไปที่หน้าแรก > อัตโนมัติ > Event Streaming > เหตุการณ์ผลิต
3. ป้อน URL ของไซต์ที่คุณต้องการสมัครรับข้อมูล (ในกรณีนี้คือ http://test siteโปรดิวเซอร์:8000) ในฟิลด์ URL ของผู้ผลิต
4. เพิ่มประเภทเอกสารทั้งหมดที่คุณต้องการสมัครใช้งาน ในตาราง Event Producer Document Types
5. หากคุณต้องการสร้างเอกสารที่มีชื่อเดียวกับที่อยู่ในไซต์ Event Producer ระยะไกล ให้เลือกช่องกาเครื่องหมาย 'ใช้ชื่อเดียวกัน' ในตารางเทียบกับประเภทเอกสารที่ต้องการ
6.  ตั้งค่าฟิลด์ Event Subscriber เป็นผู้ใช้ที่จะใช้ในการสร้างเอกสารที่ดึงมาจาก Event Producer คุณต้องสร้างผู้ใช้เดียวกันทั้งสองวิธี เช่น บน Event   Consumer และไซต์ Event Producer ก่อนที่จะสร้าง Event Producer
7. วางคีย์ API และ API Secret ที่คุณสร้างในขั้นตอนแรก (2.1) ในคีย์ API และฟิลด์ข้อมูลลับของ API ตามลำดับ
8. บันทึก
9. หลังจากบันทึกแล้ว Event Consumer จะถูกสร้างขึ้นบนไซต์ผู้ผลิต (http://test siteโปรดิวเซอร์:8000) คีย์ของผู้ใช้บนไซต์ผู้บริโภคจะถูกคัดลอกโดยอัตโนมัติไปยังเอกสาร Event Consumer บนไซต์ผู้ผลิตในกระบวนการนี้

    ![Event Producer](/docs/assets/img/automation/event-producer-doc.png)

> **หมายเหตุ** : หากมีการเปลี่ยนแปลงความลับของ API สำหรับผู้ใช้ในไซต์เหล่านี้ คุณจะต้องอัปเดตคีย์ด้วยตนเองใน Event Producer เช่นเดียวกับ Event Consumer บนไซต์ทั้งสอง

### อนุมัติผู้บริโภคเหตุการณ์บนไซต์ผู้ผลิตเหตุการณ์

1. หลังจากสร้าง Event Producer แล้ว Event Consumer จะถูกสร้างขึ้นบนไซต์ผู้ผลิตโดยอัตโนมัติ โดยค่าเริ่มต้น ชนิดเอกสารที่สมัครรับข้อมูลทั้งหมดจะมีสถานะเป็น 'รอดำเนินการ' เพื่อให้ผู้บริโภคเหตุการณ์สามารถใช้เอกสารประเภทเอกสารเหล่านี้ได้ สถานะของพวกเขาจะต้องได้รับการอัปเดตเป็น 'อนุมัติ'
2. ไปที่: **หน้าแรก> อัตโนมัติ > Event Streaming > กิจกรรมของผู้บริโภค**
3. เมื่อคุณเปิดเอกสาร Event Consumer คุณจะเห็นประเภทเอกสารทั้งหมดที่ผู้ใช้บริการสมัครรับข้อมูล เปลี่ยนสถานะจาก 'รอดำเนินการ' เป็น 'อนุมัติ' สำหรับเอกสารทุกประเภทที่คุณต้องการอนุมัติให้ใช้งาน คุณสามารถเปลี่ยนสถานะเป็น 'ปฏิเสธ' ได้ หากคุณไม่ต้องการให้มีการใช้เอกสารประเภทเอกสารนั้น
4. บันทึก

    ![Event Consumer](/docs/assets/img/automation/event-consumer-doc.png)

>**หมายเหตุ** : การอัปเดตเอกสารสำหรับประเภทเอกสารที่สมัครจะไม่ซิงค์เว้นแต่จะได้รับอนุมัติ

### 2.5 การเข้าถึงแบบออฟไลน์ด้วยไซต์เดียว 
หากคุณมีสถานที่บางแห่งที่การเชื่อมต่ออินเทอร์เน็ตต่ำ เช่น ร้านค้าในพื้นที่ห่างไกลที่มีการสร้างใบแจ้งหนี้การขาย และคุณต้องการซิงค์ใบแจ้งหนี้เหล่านี้จากร้านค้าไปยังบัญชีที่โฮสต์ คุณสามารถตั้งค่าการซิงค์ออฟไลน์โดยใช้ขั้นตอนต่อไปนี้::

1. ตั้งค่าอินสแตนซ์ภายในเครื่อง ERPNext คุณสามารถอ้างอิง [ที่นี่](https://github.com/frappe/bench) สำหรับการตั้งค่า
2. คุณต้องมีบัญชีโฮสต์กับบริษัทของคุณตั้งค่า
3. ตอนนี้สร้าง Event Producer ในบัญชีที่โฮสต์และตั้งค่า URL ผู้ผลิตเป็น URL ของบัญชีท้องถิ่นของคุณ
4. เพิ่มเอกสาร (doctypes) ใดๆ ที่คุณต้องการซิงค์ในตารางย่อย Event Producer Document Types
5. อนุมัติประเภทเอกสาร

## 3. คุณสมบัติ


### 3.1 ยกเลิกการดัปเดท

ในฐานะผู้บริโภคกิจกรรม หากคุณต้องการยกเลิกการสมัครรับการอัปเดตสำหรับเอกสารประเภทใดก็ตามที่คุณเคยสมัครรับข้อมูลก่อนหน้านี้ ให้ตรวจสอบการยกเลิกการสมัครกับประเภทเอกสารนั้น คุณจะไม่ได้รับการอัปเดตใด ๆ เพิ่มเติมจากไซต์ผู้ผลิตสำหรับประเภทเอกสารนั้น ๆ เมื่อคุณยกเลิกการสมัครแล้ว

![Unsubscribe](/docs/assets/img/automation/unsubscribe-event.png)

### 3.2 บันทึกการอัปเดตกิจกรรม

"บันทึกการอัปเดตกิจกรรม" จะบันทึกทุกการดำเนินการที่สร้าง อัปเดต และลบสำหรับเอกสารที่มีผู้ใช้บริการบนไซต์ Event Producer เพื่อดูบันทึกการอัปเดตกิจกรรม:

ไปที่: **หน้าหลัก> อัตโนมัติ> Event Streaming> กิจกรรมปรับปรุงเข้าสู่ระบบ**

- สำหรับ 'สร้าง' ให้พิมพ์ประเภทการอัปเดต ประเภทเอกสาร ชื่อเอกสาร และเอกสารทั้งหมด (ตาม JSON)
- สำหรับ 'อัปเดต' ให้พิมพ์ประเภทการอัปเดต ประเภทเอกสาร ชื่อเอกสาร และข้อมูลที่อัปเดต (ความแตกต่างระหว่างสถานะก่อนหน้าและสถานะปัจจุบันของเอกสาร)
- สำหรับ 'ลบ' ให้บันทึกเฉพาะประเภทการอัปเดต ประเภทเอกสาร และชื่อเอกสารเท่านั้น

![Event Update Log](/docs/assets/img/automation/event-update-log-doc.png)

### 3.3 บันทึกการซิงค์เหตุการณ์

เช่นเดียวกับบันทึกการอัปเดต Event Sync Log จะบันทึกทุกเอกสารที่ซิงค์จาก Event Producer บนไซต์ Event Consumer ในการดูบันทึกการซิงค์เหตุการณ์:

**ไปที่: หน้าหลัก > อัตโนมัติ> Event Streaming > กิจกรรมซิงค์เข้าสู่ระบบ**

![Event Sync Log](/docs/assets/img/automation/event-sync-log.png)

หากซิงค์สำเร็จจะสร้างเอกสารบันทึกด้วย:

- **ประเภทการอัปเดต** : สร้าง อัปเดต หรือลบ
- **สถานะ** : สถานะการซิงค์
- **เอกสาร (DocType)**
- **Event Producer** : URL ของไซต์ที่สร้างเอกสาร
- **ชื่อเอกสาร**
- **ชื่อเอกสารระยะไกล** : หากไม่ได้เลือก 'ใช้ชื่อเดียวกัน'
- **ใช้ชื่อเดียวกัน**
- **ข้อมูล** : ข้อมูลเอกสารเป็น JSON

    ![Event Sync Log](/docs/assets/img/automation/event-synced.png)

เหตุการณ์ที่ล้มเหลวจะสร้างเอกสารบันทึกที่มีฟิลด์ด้านบนพร้อมกับ:

- **ข้อผิดพลาด** : ข้อผิดพลาดเนื่องจากการไม่ซิงค์เอกสาร
    ![Event Synced](/docs/assets/img/automation/event-failed-error.png)

- **ปุ่ม ซิงค์อีกครั้ง** : นอกจากนี้ยังมีปุ่ม 'Resync' เพื่อซิงค์เหตุการณ์ที่ล้มเหลวอีกครั้ง
    ![Event Failed](/docs/assets/img/automation/event-failed.png)

### 3.4 การซิงค์แบบมีเงื่อนไข

เอกสารบางประเภทมีการขึ้นต่อกัน ตัวอย่างเช่น ก่อนที่จะซิงค์ใบกำกับสินค้า รายการและลูกค้าจะต้องมีอยู่ในไซต์ปัจจุบัน ดังนั้น รายการและลูกค้าจึงเป็นการพึ่งพาสำหรับใบกำกับสินค้า การสตรีมเหตุการณ์จัดการสิ่งนี้ด้วยการซิงค์การขึ้นต่อกันแบบออนดีมานด์ เมื่อใดก็ตามที่ต้องการซิงค์เอกสาร อันดับแรกจะตรวจสอบว่าเอกสารมีการขึ้นต่อกันหรือไม่ (ฟิลด์ลิงก์ ฟิลด์ลิงก์ไดนามิก ฟิลด์ตารางย่อย ฯลฯ) หากการขึ้นต่อกันนั้นไม่ครบถ้วน เช่น เอกสารอ้างอิง (เช่น: รายการ) ไม่มีอยู่ในไซต์ผู้บริโภคของคุณ เอกสารนั้นจะถูกซิงค์ก่อน จากนั้นจึงซิงค์ใบแจ้งหนี้การขาย

ตัวอย่างเช่น: การซิงค์ใบแจ้งหนี้การขายกับการพึ่งพาสินค้า:
    ![Event Dependency](/docs/assets/img/automation/event-dependency-sync.gif)

### 3.5 การกำหนดค่าการตั้งชื่อ

ทำเครื่องหมายที่ช่อง 'ใช้ชื่อเดียวกัน' เพื่อให้เอกสารมีชื่อเหมือนกันทั้งบนไซต์ Event Producer และ Event Consumer หากไม่ได้ตรวจสอบ เอกสารจะถูกสร้างขึ้นโดยใช้หลักการตั้งชื่อของไซต์ปัจจุบัน

![Use Same Name Config](/docs/assets/img/automation/event-use-same-name.png)

> **หมายเหตุ** : สำหรับประเภทเอกสารที่มีการตั้งชื่อชุดข้อมูล ขอแนะนำให้ยกเลิกการเลือกช่องทำเครื่องหมาย 'ใช้ชื่อเดียวกัน' เพื่อป้องกันความขัดแย้งในการตั้งชื่อ หากไม่ได้เลือก เอกสารจะถูกสร้างขึ้นโดยปฏิบัติตามข้อตกลงการตั้งชื่อบนไซต์ปัจจุบัน และฟิลด์แบบกำหนดเอง 'Remote Site Name' และ 'Remote Document Name' จะถูกตั้งค่าในเอกสารที่ซิงค์เพื่อเก็บ URL ไซต์ Event Producer และชื่อเอกสาร บนไซต์ระยะไกลตามลำดับ

![Subscribed Document](/docs/assets/img/automation/event-subscribed-doc.png)

### 3.6 การกำหนดค่าการตั้งค่า

หากคุณต้องการสตรีมเอกสารระหว่างอินสแตนซ์ ERPNext และแอป Frappe อื่นสำหรับประเภทเอกสารเฉพาะที่มีโครงสร้างเหมือนกันหรือต่างกัน หรือหากชื่อฟิลด์ต่างกันในทั้งสองไซต์ คุณสามารถใช้การสตรีมเหตุการณ์ด้วยการกำหนดค่าการแมป

สำหรับสิ่งนี้ คุณต้องตั้งค่าการแมปประเภทเอกสารก่อน

ในการเข้าถึงการแมปประเภทเอกสาร ไปที่:

> หน้าหลัก > ระบบอัตโนมัติ > การสตรีมเหตุการณ์ > การแมปประเภทเอกสาร

#### 3.6.1 การแมปสำหรับเอกสาร (DocTypes) ที่มีโครงสร้างคล้ายกัน

- **Mapping Name** : ตั้งชื่อเฉพาะให้กับแผนที่ the
- **Local Document Type** : ประเภทเอกสารในไซต์ปัจจุบันของคุณ
- **Remote Document Type** : ประเภทเอกสารบนไซต์ Event Producer ที่คุณต้องการซิงค์

ในตารางย่อยการแมปฟิลด์:

- **Local Fieldname** : ชื่อฟิลด์ในประเภท Local Document ของไซต์ปัจจุบันของคุณ
- **Remote Fieldname** : ชื่อฟิลด์ในประเภท Remote Document ของไซต์ Event Producer ที่คุณต้องการแมปกับ Local Fieldname ในระหว่างการซิงค์ ค่าของชื่อฟิลด์ระยะไกลจะถูกคัดลอกไปยังชื่อฟิลด์ในเครื่อง

![Document Type Mapping](/docs/assets/img/automation/event-field-mapping.png)

#### 3.6.2 ค่าเริ่มต้นสำหรับบางฟิลด์

ถ้าฟิลด์ของคุณไม่ได้ถูกแมปกับชื่อฟิลด์ระยะไกลอื่น ๆ และคุณต้องการให้ฟิลด์มีค่าเท่ากันเสมอ ให้ตั้งค่าชุดเดียวกันในฟิลด์ค่าเริ่มต้น เหตุการณ์ หากคุณได้ตั้งค่าชื่อฟิลด์ระยะไกล ในกรณีที่ในระหว่างการซิงค์ ไม่พบค่าของฟิลด์ระยะไกล และหากระบุ "ค่าเริ่มต้น" ไว้ จะถูกตั้งค่า

![Child Table Mapping Link](/docs/assets/img/automation/default.png)


#### 3.6.3 การแมปสำหรับเอกสาร DocTypes ที่มีตารางลูก

ถ้าเขตข้อมูลที่คุณพยายามแมปเป็นตารางย่อย คุณต้องสร้างการแมปชนิดเอกสารอื่นสำหรับเขตข้อมูลตารางรอง

![Child Table Mapping Link](/docs/assets/img/automation/child_table_map_doc.png)

- **ประเภทการทำแมปปิ้ง** : เลือกประเภทการทำแผนที่เป็นตารางย่อย
- **การทำแมปปิ้ง** : เลือกเอกสารการแมปประเภทเอกสารที่คุณสร้างขึ้นสำหรับตารางรอง

![Child Table Mapping Link](/docs/assets/img/automation/event-map-is-child-table.png)

#### 3.6.4 การแมปสำหรับเอกสาร (DocTypes) ที่มีการขึ้นต่อกัน (ลิงก์ ฟิลด์ลิงก์แบบไดนามิก) 

หากเอกสาร (DocTypes) ที่คุณพยายามแมปมีการขึ้นต่อกันประเภทใดก็ตาม เช่น ช่องลิงก์หรือลิงก์แบบไดนามิก คุณต้องตั้งค่าการแมปประเภทเอกสารอื่นสำหรับการซิงค์การขึ้นต่อกัน

ตัวอย่างเช่น สมมติว่า doctype ในเครื่องคือ Opportunity และเอกสาร doctype ระยะไกลคือ ERPNext Opportunity ฟิลด์ `party_name` (( ฟิลด์ลิงก์สำหรับ DocType Lead) ในโอกาสถูกแมปกับ `full_name` (ฟิลด์ข้อมูล) ในโอกาส ERPNext ในระหว่างการซิงค์ ต้องสร้างลูกค้าเป้าหมายนี้เพื่อให้โอกาสหลักในการซิงค์ ดังนั้นคุณต้องตั้งค่าการแมปสำหรับฟิลด์ลิงก์นี้ด้วย

![Lead Dependency Creation](/docs/assets/img/automation/lead_dependency_creation.png)

- **ประเภทการทำการแมปปิ้ง** : ในกรณีนี้ ประเภทการทำแผนที่คือเอกสาร
- **การทำการแมปปิ้ง** : เลือกการทำแผนที่ที่คุณเพิ่งสร้างขึ้น
- **ตัวกรองค่าระยะไกล** : คุณต้องระบุตัวกรองที่จะดึงเอกสารระยะไกลที่แน่นอนที่จะจับคู่ เช่นเดียวกับในกรณีนี้ DocType ระยะไกลคือ ERPNext Opportunity ซึ่งสามารถดึงข้อมูลโดยไม่ซ้ำกันโดยใช้ชื่อ หมายเลขโทรศัพท์ และประเทศ

รูปแบบคือ:

{ "remote fieldname": "field หรือ expression จากตำแหน่งที่เราจะรับค่าสำหรับ fieldname นั้น"}

หากคุณต้องการดึงค่าจากที่ใดที่หนึ่ง ให้เริ่มนิพจน์ด้วย eval:

เช่นในกรณีนี้คือ: `eval:frappe.db.get_value('Global Defaults', None, 'country')`

![Document Mapping Type](/docs/assets/img/automation/document_mapping_type.png)

สุดท้าย เปิดใช้งานตัวเลือก 'มีการแมป' ในตารางย่อยการกำหนดค่าเหตุการณ์ใน Event Producer กับประเภทเอกสารที่จำเป็น และเลือกการแมปประเภทเอกสารที่คุณเพิ่งสร้างขึ้น

![Mapping Configuration](/docs/assets/img/automation/event-mapping-conf.png)

### 3.6 การกำหนดค่าเหตุการณ์ตามเงื่อนไข

หากคุณอยู่ในสถานการณ์ที่ไม่ต้องการส่งเอกสารทั้งหมดในประเภทเอกสารไปให้ผู้บริโภค คุณสามารถระบุเงื่อนไขสำหรับเอกสารเหล่านั้นได้

ตัวอย่างเช่น หากคุณต้องการ `Note` เผยแพร่เฉพาะเอกสารที่เป็นสาธารณะ คุณสามารถระบุได้ในเอกสารผู้ผลิต/ผู้บริโภค

![Child Table Mapping Link](/docs/assets/img/automation/event-streaming-conditions.png)

> หากเอกสารตรงตามเงื่อนไขตลอดอายุการใช้งาน เอกสารเก่าทั้งหมด `Event Update Logs` จะซิงค์กับผู้บริโภค

ลองพิจารณาอีกตัวอย่างหนึ่ง คุณต้องการซิงค์เฉพาะใบแจ้งหนี้การขายที่ส่ง คุณสามารถระบุ `doc.docstatus == 1` เป็นเงื่อนไข ใบแจ้งหนี้จะไม่ถูกซิงค์จนกว่าจะส่ง

สำหรับบันทึกการอัปเดตแต่ละรายการ คุณสามารถดู Consumers ได้ในเอกสารบันทึกการอัปเดต

หากคุณต้องการควบคุมเงื่อนไขที่ละเอียดยิ่งขึ้น คุณสามารถเชื่อมต่อฟังก์ชันแบบกำหนดเองได้ ฟังก์ชั่นของคุณจะถูกดำเนินการด้วยพารามิเตอร์ `consumer`, `doc` และ `update_log` ตัวอย่างเช่น คุณต้องการซิงค์เฉพาะบันทึกย่อที่เป็น `odd`

```py
def is_odd_note(consumer, doc, update_log):
    return frappe.db.sql("""
        SELECT
            COUNT(*)
        FROM `tabNote`
        WHERE creation <= %(creation)s
    """, { "creation": doc.creation })[0][0] % 2 != 0
```

จากนั้นคุณสามารถระบุเงื่อนไข:

```js
cmd: my_custom_app.note.is_odd_note
```